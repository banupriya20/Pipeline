<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Grpc.Tools MSBuild integration overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="namespace_grpc_1_1_tools.html">Grpc.Tools</a> MSBuild integration overview </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an overview for maintainers of <a class="el" href="namespace_grpc_1_1_tools.html">Grpc.Tools</a>.</p>
<p>The <a class="el" href="namespace_grpc_1_1_tools.html">Grpc.Tools</a> NuGet package provides custom build targets to make it easier to specify <code>.proto</code> files in a project and for those files to be compiled and their generated files to be included in the project.</p>
<h1><a class="anchor" id="autotoc_md68"></a>
Files in the NuGet package</h1>
<h2><a class="anchor" id="autotoc_md69"></a>
.props and .target files</h2>
<p>MSBuild properties and targets included from the <a class="el" href="namespace_grpc_1_1_tools.html">Grpc.Tools</a> NuGet package are in:</p>
<ul>
<li><code>build\Grpc.Tools.props</code>, which imports<ul>
<li><code>build\_grpc\_Grpc.Tools.props</code></li>
<li><code>build\_protobuf\Google.Protobuf.Tools.props</code></li>
</ul>
</li>
<li><code>build\Grpc.Tools.targets</code>, which imports<ul>
<li><code>build\_grpc\_Grpc.Tools.targets</code></li>
<li><code>build\_protobuf\Google.Protobuf.Tools.targets</code></li>
</ul>
</li>
</ul>
<p>Details of how NuGet packages can add custom build targets and properties to a project is documented here: <a href="https://learn.microsoft.com/en-us/nuget/concepts/msbuild-props-and-targets">MSBuild .props and .targets in a package</a></p>
<p>Basically the <code>.props</code> and <code>.targets</code> files are automatically included in the projects - the <code>.props</code> at the top of the project and the <code>.targets</code> are added to the bottom of the project.</p>
<h2><a class="anchor" id="autotoc_md70"></a>
Visual Studio property pages</h2>
<p>For Visual Studio integration - these files provide the properties pages:</p>
<ul>
<li><code>build\_protobuf\Protobuf.CSharp.xml</code> (included from <code>Google.Protobuf.Tools.targets</code>)</li>
<li><code>build\_grpc\Grpc.CSharp.xml</code> (included from <code>_Grpc.Tools.targets</code>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md71"></a>
Custom tasks DLLs</h2>
<p>DLLs containing the custom tasks are in:</p>
<ul>
<li><code>build\_protobuf\netstandard1.3</code></li>
<li><code>build\_protobuf\net45</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md72"></a>
Protobuf compiler and C# gRPC plugin binaries</h2>
<p>Native binary executables for the protobuf compiler (<em>protoc</em>) and C# gRPC plugin (<em>grpc_csharp_plugin</em>) are included in the NuGet package. Included are binaries for various OSes (Windows, Linux, macOS) and CPU architectures (x86, x64, arm64).</p>
<p>The build determines which executables to use for the particular machine that the it is being run on. These can be overridden by specifying MSBuild properties or environment variables to give the paths to custom executables:</p>
<ul>
<li><code>Protobuf_ProtocFullPath</code> property or <code>PROTOBUF_PROTOC</code> environment variable \ Full path of protoc executable</li>
<li><code>gRPC_PluginFullPath</code> property or <code>GRPC_PROTOC_PLUGIN</code> environment variable \ Full path of gRPC C# plugin</li>
</ul>
<h1><a class="anchor" id="autotoc_md73"></a>
Grpc.Tools custom build targets</h1>
<h2><a class="anchor" id="autotoc_md74"></a>
Hooking the custom targets into the project build</h2>
<p>The custom targets hook into various places in a normal MSBuild build by specifying before/after targets at the relevant places. See <a href="https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-targets">msbuild-targets</a> for predefined targets.</p>
<ul>
<li>Before <code>PrepareForBuild</code><ul>
<li>we add <code>Protobuf_SanityCheck</code> that checks this is a supported project type, e.g. a C# project.</li>
</ul>
</li>
<li>Before <code>BeforeCompile</code><ul>
<li>we add all the targets that compile the <code>.proto</code> files and generate the expected <code>.cs</code> files. These files are added to those that get compiled by the C# compiler.<ul>
<li>The target <code>_Protobuf_Compile_BeforeCsCompile</code> is the <em>glue</em> inserting the targets into the build. It may look like it isn't doing anything but by specifying <code>BeforeTargets</code> and <code>DependsOnTargets</code> it inserts <code>Protobuf_Compile</code> into the build - but only doing so if this is a C# project.</li>
</ul>
</li>
</ul>
</li>
<li>After <code>CoreClean</code><ul>
<li>we add <code>Protobuf_Clean</code> that cleans the files generated by the protobuf compiler.<ul>
<li>The target <code>_Protobuf_Clean_AfterCsClean</code> is the <em>glue</em> inserting <code>Protobuf_Clean</code> into the build - but only doing so if this is a C# project.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md75"></a>
Custom tasks</h2>
<p>There are a few custom tasks needed by the targets. These are implemented in C# in the <a class="el" href="namespace_grpc_1_1_tools.html">Grpc.Tools</a> project and packaged in the file <code>Protobuf.MSBuild.dll</code> in the NuGet package. See <a href="https://learn.microsoft.com/en-us/visualstudio/msbuild/task-writing">task writing</a> for information about implementing custom tasks.</p>
<ul>
<li>ProtoToolsPlatform<ul>
<li>Works out the operating system and CPU architecture</li>
</ul>
</li>
<li>ProtoCompilerOutputs<ul>
<li>Tries to work out the names and paths of the files that would be generated by the protobuf compiler and returns these as a list of items</li>
<li>Also returns list of items that is the same as the <code>Protobuf</code> items passed in with the output directory metadata updated</li>
</ul>
</li>
<li>ProtoReadDependencies<ul>
<li>Read generated files from previously written dependencies file and return as items.</li>
</ul>
</li>
<li>ProtoCompile<ul>
<li>Runs the protobuf compiler for a proto file. The executable to run is specified by the property <code>Protobuf_ProtocFullPath</code></li>
<li>To do this it:<ul>
<li>first writes out a response file containing the parameters for protobuf compiler</li>
<li>runs the executable, which generates the <code>.cs</code> files and a <code>.protodep</code> dependencies file</li>
<li>reads the dependencies file to find the files that were generated and these are returned as a list of <em>items</em> that can then be used in the MSBuild targets</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md76"></a>
Build steps</h2>
<p>The names of these items and properties are correct at the time of writing this document.</p>
<p>High level builds steps:</p>
<ul>
<li>Prepare list of <code>.proto</code> files to compile<ul>
<li>Makes sure all needed metadata is set for the <code>&lt;Protobuf&gt;</code> item, defaulting some values</li>
<li>Removes <code>&lt;Protobuf&gt;</code> items that no longer exist or are marked as don't compile</li>
</ul>
</li>
<li>Handling incremental builds<ul>
<li>Work out files that need to be created or have changed</li>
</ul>
</li>
<li>Compile the <code>.proto</code> files</li>
<li>Add generated files to the list of files for the C# compiler</li>
</ul>
<h3><a class="anchor" id="autotoc_md77"></a>
Prepare the list of .proto files to compile</h3>
<p>At various stages of the build copies of the original <code>&lt;Protobuf&gt;</code> items are created and/or updated to set metadata and to prune out unwanted items.</p>
<p>Firstly, the build makes sure <code>ProtoRoot</code> metadata is set for all <code>Protobuf</code> items. A new list of items - <code>Protobuf_Rooted</code> - is created from the <code>Protobuf</code> items with <code>ProtoRoot</code> metadata set:</p>
<ul>
<li>If <code>ProtoRoot</code> already set in the <code>&lt;Protobuf&gt;</code> item in the project file then it is left as-is.</li>
<li>If the <code>.proto</code> file is under the project's directory then set <code>ProtoRoot="."</code>.</li>
<li>If the <code>.proto</code> file is outside of the project's directory then set <code>ProtoRoot="&lt;relative path to project directory&gt;"</code>.</li>
</ul>
<p>Now prune out from <code>Protobuf_Rooted</code> the items that the user doesn't want to compile - those don't have <code>ProtoCompile</code> metadata as <code>true</code>. The pruned list is now called <code>Protobuf_Compile</code>.</p>
<p>Set the <code>Source</code> metadata on <code>Protobuf_Compile</code> items to be the name of the <code>.proto</code> file. The <code>Source</code> metadata is used later as a key to map generated files to <code>.proto</code> files.</p>
<h3><a class="anchor" id="autotoc_md78"></a>
Handling incremental builds</h3>
<h4><a class="anchor" id="autotoc_md79"></a>
Gathering files to check for incremental builds</h4>
<p>The target <code>Protobuf_PrepareCompile</code> tries to work out which files the protobuf compiler will generate without actually calling the protobuf compiler. This is a best-effort guess. The custom task <code>ProtoCompilerOutputs</code> is called to do this. The results are stored in the item list <code>Protobuf_ExpectedOutputs</code>.</p>
<p>The target <code>Protobuf_PrepareCompile</code> also reads previously written <code>.protodep</code> files to get any actual files previously generated. The custom task <code>ProtoReadDependencies</code> is called to do this. The results are stored in the item list <code>Protobuf_Dependencies</code>. This is in case the list of actual files is different from the previous best-effort guess from <code>ProtoCompilerOutputs</code>.</p>
<p>The expected outputs and previous outputs are needed so that the timestamps of those files can be checked later when handling an incremental build.</p>
<h4><a class="anchor" id="autotoc_md80"></a>
Understanding incremental builds</h4>
<p>To avoid unnecessarily recompiling the <code>.proto</code> files during an incremental build the target <code>_Protobuf_GatherStaleBatched</code> tries to work out if any files have changed.</p>
<p>It checks for out of date files using MSBuilds incremental build feature that compares the timestamps on a target's <em>Input</em> files to its <em>Output</em> files. See <a href="https://learn.microsoft.com/en-us/visualstudio/msbuild/how-to-build-incrementally">How to: Build incrementally</a></p>
<p>The <em>Inputs</em> that are checked are:</p><ul>
<li>Timestamps of the <code>.proto</code> files</li>
<li>Timestamps of previously generated files (list of these files read from <code>.protodep</code> files)</li>
<li>Timestamps of MSBuild project files</li>
</ul>
<p>These are checked against the <em>Outputs</em>:</p><ul>
<li>Timestamps of the expected generated files</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/visualstudio/msbuild/item-metadata-in-target-batching">MSBuild target batching</a> is used to check each <code>.proto</code> file against its expected outputs. The batching is done by specifying the <code>Source</code> metadata in the <em>Input</em>. Items where <code>Source</code> metadata matches in both input and output are in each batch.</p>
<p>The target <code>_Protobuf_GatherStaleBatched</code> sets the metadata <code>_Exec=true</code> on <code>_Protobuf_OutOfDateProto</code> items that are out of date.</p>
<p>Later in the target <code>_Protobuf_GatherStaleFiles</code>, the items in <code>_Protobuf_OutOfDateProto</code> that don't have metadata <code>_Exec==true</code> are removed from the list of items, leaving only those that need compiling.</p>
<h3><a class="anchor" id="autotoc_md81"></a>
Compile the .proto files</h3>
<p>The target <code>_Protobuf_CoreCompile</code> is run for each <code>.proto</code> file that needs compiling. These are in the item list <code>_Protobuf_OutOfDateProto</code>. The custom task <code>ProtoCompile</code> is called to run the protobuf compiler. The files that were generated are returned in the item list <code>_Protobuf_GeneratedFiles</code>.</p>
<p>If there are expected files that were not actually generated then the behaviour depends on whether the generated files should have been within the project (e.g. in the intermediate directories) or were specified to be outside of the project.</p><ul>
<li>If within the project - empty files are created to prevent incremental builds doing unnecessary recompiles</li>
<li>If outside the project - by default empty files are not created and a warning is output (this behaviour is configurable)</li>
</ul>
<p><b>TODO:</b> why are files inside and outside the project treated differently?</p>
<h3><a class="anchor" id="autotoc_md82"></a>
Add generated .cs files to the list of files for the C# compiler</h3>
<p>The target <code>_Protobuf_AugmentLanguageCompile</code> adds to the <code>Compile</code> item list (the list of files that CSC compiles) the expected generated files.</p>
<p><b>Note</b> - this is the <em>expected</em> files not the <em>actual</em> generated files and this is done before the protobuf compiler is called.</p>
<p><b>TODO:</b> why are the <em>expected</em> files not the <em>actual</em> generated files added?</p>
<h2><a class="anchor" id="autotoc_md83"></a>
Handling design time builds</h2>
<p>Design-time builds are special builds that Visual Studio uses to gather information about the project. They are not user-initiated but may be triggered whenever files are added, removed or saved. See <a href="https://github.com/dotnet/project-system/blob/main/docs/design-time-builds.md">Design-Time Builds</a>.</p>
<p>The <a class="el" href="namespace_grpc_1_1_tools.html">Grpc.Tools</a> build targets used to try and optimise design time builds by disabling calling the protobuf compiler during a design time build. However this optimisation can lead to errors in Visual Studio because the generated files may not exist or be out of date and any code that relies on them will then have errors.</p>
<p>Now design time builds behave exactly the same as a normal build. The old behaviour can be enabled by setting the setting <code>DisableProtobufDesignTimeBuild</code> property to <code>true</code> in the project file **_if_** it is a design time build, e.g. by adding</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">PropertyGroup</span> <span class="keyword">Condition</span>=<span class="stringliteral">&quot;&#39;$(DesignTimeBuild)&#39; == &#39;true&#39; &quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">DisableProtobufDesignTimeBuild</span>&gt;<span class="keyword">true</span>&lt;/<span class="keywordtype">DisableProtobufDesignTimeBuild</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">PropertyGroup</span>&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md84"></a>
Automatically including .proto files</h2>
<p>For SDK projects it is possible to automatically include <code>.proto</code> files found in the project directory or sub-directories, without having to specify them with a <code>&lt;Protobuf&gt;</code> item. To do this the property <code>EnableDefaultProtobufItems</code> has be set to <code>true</code> in the project file.</p>
<p>By default it is not set and <code>&lt;Protobuf&gt;</code> items must be included in the project for the <code>.proto</code> files to be compiled. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
